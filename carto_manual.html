<p>===So what is Carto ?===</p>
<p>Mapnik is a popular tool to render, that is display, geographic information into images.</p>
<p>Mapnik's code instructs what features (roads, rivers, buildings) to display and what these features should look like (this is known as rendering), is in XML. It's very difficult to read. In 2009(ish?), cascadenik was made to help simplify this.</p>
<p>Then, carto (also known as CartoCSS, but for the rest of this manual, it will be referred to as Carto) was set out to provide an easier way to write these instructions while taking full advantage of mapnik's rendering capabilities and is superceding cascadenik.</p>
<p>It's like the CSS language (and less.js), it's used to style maps in the application, Tilemill.</p>
<p>== Organizing your data ==</p>
<p>Before you even start making your map, organize your geospatial data however you'd like. Tilemill supports postgis, SHP, geojson, CSV (must be formatted correctly - see http://www.mapbox.com/tilemill/docs/guides/google-docs/) and maybe something else. Make sure that data is in the same projection used in Tilemill, EPSG:4326.</p>
<p>If you're really particular on performance or want to render large amount of data (like entire countries), go with postgis and shp instead of geojson or spreadsheets.</p>
<p>SQL Queries:</p>
<p>Additionally: If you're using a postgis DB, you want your layers to be as specific as possible. Just as using <code>select * FROM yourtablename</code> is inefficient in your postgresql queries because you're selecting everything, using select * queries in Tilemill will increase the time needed to load your map. Simply put, your layer's query should only select the data that you will want to display on your map.</p>
<p>Here's a very simple SQL query for a layer:</p>
<pre><code> (select shop from planet_osm_point where shop is not null) as points</code></pre>
<p>(if you're importing data from osm2pgsql see http://wiki.openstreetmap.org/wiki/Osm2pgsql/schema for the names of tables)</p>
<p>Let's show what this means:</p>
<p>Shop is your column name, planet_osm_point is your table name and points is an arbitrary name. You can name it whatever you want.</p>
<table>
<col width="5%" />
<tbody>
<tr class="odd">
<td align="left">First things first (aka: things that in tilemill and that I really wish I knew when I started using tilemill:</td>
</tr>
<tr class="even">
<td align="left"><em>What data should go in each layer?</em> <em>Should I make one for all roads? railways? Labels?</em> - This question really confused me as a newbie tilemill user. This is a question is a bit difficult to answer because it depends on the map that you're making. Generally, The more features that your map will include, the more layers that you'll want. Do not try to put everything in one layer, even if all of your data is in one file.</td>
</tr>
<tr class="odd">
<td align="left">If you're making a map that will feature distinct styling for bridges and tunnels and multiple types of highways, you'll likely have multiple layers there (one for bridges, one for highways, one for tunnels, etc). Many popular stylesheets have 3 separate road stylesheets, one for lower zoom levels (like 10-13ish), medium (14-17ish) and more detailed (18+), plus separate ones for all tunnels and bridges.</td>
</tr>
<tr class="even">
<td align="left">One applicable rule that is applicable for nearly every tilemill map is that you should have a layer solely dedicated to labels :)</td>
</tr>
<tr class="odd">
<td align="left"><em>what programs do I use to edit my stylesheets (.mss) and my project file (.mml)?</em> - You can edit them within tilemill itself. You can also use your own preferred text editor (sublime, notepad, vim, emacs). Editing them within your own preferred text editor is is especially useful when you have multiple MSS files in your browser. If you edit and save your file in your text editor, tilemill will automatically detect the changes, refresh, and display the changes.</td>
</tr>
<tr class="even">
<td align="left">* For writing selectors like <code>highway='specifictypeofstreetforexample'</code> use single quotes. Double quotes also work in Tilemill, it's just a standard practice by other tilemill users to use single quotes.</td>
</tr>
<tr class="odd">
<td align="left">* the order of your MSS files, from left to right within your tilemill - does not matter). Neither do the names of the MSS files - they do not have to match the name of your layers. Use whatever names that are easy for you to remember.</td>
</tr>
<tr class="even">
<td align="left">* Also, if you do not know by now, you can launch multiple instances of tilemill. This is useful if you're working on multiple projects at once or if you want to test out a piece of code real quick in a new project or context, and don't want to make a branch in git for whatever reason.</td>
</tr>
<tr class="odd">
<td align="left">* You can access Tilemill through your web browser. In the terminal, go to the directory where tilemill install is located (ADD this). In this directory, type in: <code>./index.js --server=true</code>. Now, you can go to your web browser and type in localhost:20009 and your tilemill will be there.</td>
</tr>
</tbody>
</table>
<p><strong>Inheritance</strong></p>
<p>you'll want to be the field's name in single quotes. (if it's a text)</p>
<p>CSS saves you time by inheritance, so very basic:</p>
<p><code>#place[type='neighbourhood'][zoom&gt;=13][zoom&lt;=20] {   text-name:'[name]';   text-face-name:@sans;   text-placement:point;   text-fill:@other_text;   text-size:10;   text-halo-fill:@other_halo;   text-halo-radius:1;   text-wrap-width: 30;   text-min-distance: 100;   text-avoid-edges: true;   text-label-position-tolerance: 10;   [zoom&gt;=13] {     text-min-distance: 50;   }   [zoom&gt;=14] {     text-size:11;     } }</code> Here, for zoom 13 and higher, the text-min-distance is now 50 and the rest of the characteristics that are included in first selection, for zoom 14 and higher, it will have ALL of those characteristics that are included in first selection, except for the text-size is now 11.<br /> Also note that it's standard practice to use &gt;= when you write out your zoom queries and keep it consistent. Wish I knew why, but I haven't had any problems result from adapting this.</p>
<hr />
<p>==== Styling ===</p>
<p>ohh, ahh, so how do I Make stuff look purdy ?</p>
<ul>
<li>Check out the comp-op page. http://www.mapbox.com/tilemill/docs/guides/comp-op/</li>
</ul>
<hr />
<p>===Reading the API===</p>
<p>So, the api can be difficult to read if you're not familiar with reading APIs.</p>
<p>For example, see <a href="https://www.mapbox.com/carto/api/2.1.0/#polygon-pattern">The polygon-pattern-file,</a></p>
<p><code>#processed_p[zoom&gt;=10] { polygon-pattern-file:url('img/imagename.png');  }</code></p>
<p>This url path assumes that imagename.png is located in a subfolder of your project, named img.</p>
<p>Tip: For images, images that you use for polygon-pattern-file or map-background should be &quot;seamless.&quot; They should be 256x256 or 512x512 in size. If they aren't seemless, you will notice where one tile ends and the other begins (add ugly example)</p>
<table>
<col width="5%" />
<tbody>
<tr class="odd">
<td align="left">===Attachments====</td>
</tr>
<tr class="even">
<td align="left">When you see the :: being used, they're called attachments.</td>
</tr>
<tr class="odd">
<td align="left">These are pretty damn dope, extend the capabilities of Tilemill, extend your mapmaking capabilities and wish I learned these earlier.</td>
</tr>
<tr class="even">
<td align="left">``` #layername[yourfilter-isthatwhatthisiscalled]::selector {</td>
</tr>
<tr class="odd">
<td align="left">} ``` you can name your selector whatever you want, it's arbitrary.</td>
</tr>
<tr class="even">
<td align="left">Also repeated in http://www.mapbox.com/tilemill/docs/manual/carto/ (include?)</td>
</tr>
<tr class="odd">
<td align="left">Note that newsymbol is not a special keyword but an arbitrary name chosen by the user. To help keep track of different symbolizers you can name additional symbolizers whatever makes sense for the situation. Some examples: #road::casing, #coastline::glow_inner, #building::shadow.</td>
</tr>
<tr class="even">
<td align="left">To recap what was written there, the second rule will add a blue glow on top of the red line instead of replacing it: ``` #layer { line-color: red; line-width: 4; }</td>
</tr>
<tr class="odd">
<td align="left">#layer::glow { line-color: blue; line-opacity: 0.5; line-width: 8; } ``` <img src="https://github.com/skorasaurus/carto-manual/raw/master/img/example_001.png" alt="Example 001" /></td>
</tr>
<tr class="even">
<td align="left">This glow is only possible because of the line-opacity rule. Try removing that and then click save. You'll now only see a blue line, as shown in the image below:</td>
</tr>
<tr class="odd">
<td align="left"><img src="https://github.com/skorasaurus/carto-manual/raw/master/img/example_002.png" alt="Example 002" /></td>
</tr>
<tr class="even">
<td align="left">Important! Remember the painter's algorithm ! One of the most important concepts that helped me understand Tilemill.</td>
</tr>
<tr class="odd">
<td align="left">Let's explain how this works with attachments and the previous example. As you saw in the most recent example, you only saw a blue line.</td>
</tr>
<tr class="even">
<td align="left">but if we reverse the two colors, like the following :</td>
</tr>
<tr class="odd">
<td align="left">``` #layer { line-color: red; line-width: 8; }</td>
</tr>
<tr class="even">
<td align="left">#layer::glow { line-color: blue; line-width: 4; } ```</td>
</tr>
<tr class="odd">
<td align="left"><img src="https://github.com/skorasaurus/carto-manual/raw/master/img/example_003.png" alt="Example 003" /></td>
</tr>
<tr class="even">
<td align="left">In this case, you will see a blue line with a red outline or a red glow! Why? the red line with a width of 8, was drawn first, and then the blue line, with a width of 4, was drawn above the red line.</td>
</tr>
<tr class="odd">
<td align="left">With attachments, the line is drawn over the previous object! This is the painter's algorithm!</td>
</tr>
<tr class="even">
<td align="left">However, if you do not use attachments, ``` #countries { line-color: red; line-width: 8; }</td>
</tr>
<tr class="odd">
<td align="left">#countries { line-color: blue; line-width: 4; } ``` you'll only end up with a blue line that is 4 pixels wide. Without attachments, the code in the second selector only will be used.</td>
</tr>
<tr class="even">
<td align="left">If you use attachments consecutively, like: <code>#layer::first { line-color: red; line-width: 4; } #layer::glow { line-color: blue; line-width: 2; }</code> They will have the same action as the early image (not immediately before, but the 2nd one before this example)... the blue glow will be atop the red line. For simplicity's sake, you shouldn't need to do this, just remove the attachment from the first layer/</td>
</tr>
<tr class="odd">
<td align="left">(http://www.mapbox.com/tilemill/docs/guides/symbol-drawing-order/ explains pretty well, as well, wish this was there when I started)</td>
</tr>
<tr class="even">
<td align="left">In addition to attachments, the painter's algorithm applies to the entire mss file. Lines, points, and polygons that are written first in the MSS file will be drawn first. Any lines, polygons, and points that are coded later will be drawn over the earlier ones.</td>
</tr>
<tr class="odd">
<td align="left">Now, Attachment style:</td>
</tr>
<tr class="even">
<td align="left">there's no difference between: <code>#layer { ::outline { line-width: 6; line-color: black; } ::inline { line-width: 2; line-color: white; } }</code> and <code>#layer::outline { line-width: 6; line-color: black; } #layer::inline { line-width: 2; line-color: white; }</code> first version is a little easier to read :) (And has been adopted by openstreetmap-carto, osm's standard stylesheet)</td>
</tr>
<tr class="odd">
<td align="left">AJ Ashton - I don't really have a preference and will do either or both depending on the project and the data. But for OSM-Carto I think the no-repeat approach is a good fit, and it's good to have that kind of consistency on a collaborative project.</td>
</tr>
<tr class="even">
<td align="left">But remember, that if you are using multiple attachments:</td>
</tr>
<tr class="odd">
<td align="left">like: ```</td>
</tr>
<tr class="even">
<td align="left">```</td>
</tr>
<tr class="odd">
<td align="left">and ```</td>
</tr>
<tr class="even">
<td align="left">``` Even though you have used a selector in the first attachment, the</td>
</tr>
<tr class="odd">
<td align="left">(What's the diff between: <code>#place::small[type='neighbourhood'][zoom&gt;=13][zoom&lt;=20] and #place [type='neighbourhood'][zoom&gt;=13][zoom&lt;=20] ::small ? )</code></td>
</tr>
<tr class="even">
<td align="left">multiple textures, casings for lines (if you want a road to be outside with a different color than what the inside of it is...), and so much more can be done with attachments..</td>
</tr>
<tr class="odd">
<td align="left">Like this example for a railroad.</td>
</tr>
<tr class="even">
<td align="left">``` #rail [zoom&gt;=12][zoom&lt;=21]::perpendicular-dashes {</td>
</tr>
<tr class="odd">
<td align="left">line-cap: butt; line-color: black; [zoom&gt;=12] { line-width: 5.25; line-dasharray: 0.45,10; } [zoom&gt;=14] { line-width: 5.75; line-dasharray: 0.75,15;} [zoom&gt;=16] { line-width: 6.75; line-dasharray: 1.25,20; } [zoom&gt;=18] { line-width: 7; line-dasharray: 1.5,25; } [zoom&gt;=20] { line-width: 7; line-dasharray: 1.75,35; } } #rail [zoom&gt;=12][zoom&lt;=21]::base-line { line-cap: butt; line-color: black; [zoom&gt;=12] { line-width: 1; } [zoom&gt;=14] { line-width: 1.25; } [zoom&gt;=16] { line-width: 1.75; } [zoom&gt;=18] { line-width: 2; } [zoom&gt;=20] { line-width: 2.25; } } ```</td>
</tr>
<tr class="even">
<td align="left">In the above rail instance, the perpendicular-dashes are drawn first, then the base-line are drawn.</td>
</tr>
<tr class="odd">
<td align="left">==================== Selections/selectors within the Layer:</td>
</tr>
<tr class="even">
<td align="left">There are times when even if you filter the objects that you want in your layer, you want to customize styling based on certain properties within your layer.</td>
</tr>
<tr class="odd">
<td align="left">Tips: - item</td>
</tr>
<tr class="even">
<td align="left">- Adding a comma starts a whole new selector - meaning aspects of your previous selector - like the layer and zoom level) are not considered. So you need to repeat yourself a bit - and include #parkpoint[zoom=10] after your comma. It's easier to think about the separation commas cause by - always adding a new line after a comma, like this:</td>
</tr>
<tr class="odd">
<td align="left"><code>#parkpoint[zoom=10][display_designation = 'National Park'], #parkpoint[zoom=10][display_designation = 'National Park &amp; Preserve'] { }</code> <code>&lt;bFlood&gt; ajashton: is there a way to perform boolean ops between filters? so instead of #layer [field=foo][field=bar]  we could do [field1=foo] AND [field2=bar]? &lt;ajashton&gt; #layer[field1=foo][field2=bar] is an AND operation &lt;ajashton&gt; #layer[field1=foo], #layer[field2=bar] is an OR operation &lt;bFlood&gt; sorry, meant OR &lt;bFlood&gt; got it, thx &lt;ajashton&gt; you can also use nesting, like #layer { [field1=foo],[field2=bar] { /* style */ } }</code></td>
</tr>
<tr class="even">
<td align="left"><bFlood> one more, for complex expressions can you use parens to separate the logic: #layer {[field3=baa],( [field1=foo][field2=bar]) <ajashton> bFlood, no parens. Everything between commas is totally separate <ajashton> down side is that <code>x AND (y OR z)</code> has to instead be <code>(x AND Y) OR (x AND z)</code> <ajashton> (not in that syntax, tho)</td>
</tr>
<tr class="odd">
<td align="left">You can also use negatives as a selector in carto, by using: !=</td>
</tr>
<tr class="even">
<td align="left"><code>[display_designation != 'National Park'][display_designation != 'National Park &amp; Preserve']</code></td>
</tr>
<tr class="odd">
<td align="left">(display_designation is the name of a row in your data )</td>
</tr>
<tr class="even">
<td align="left">move me below bFlood&gt; how do you change the drawing order in Tilemill? <ybon> bFlood: you can change the order of the layers <bFlood> ok, how is that done from the UI? in the carto css or via the little layers popup window? <ybon> the layers window <ybon> drag the icon on the left</td>
</tr>
<tr class="odd">
<td align="left">As stated earlier, you want your layers to only include the geo_data that you want, BUT you organize your by uses.</td>
</tr>
<tr class="even">
<td align="left">In the following example, here's a postgresql query of a railway layer. like the following with way, railway as your column names.</td>
</tr>
<tr class="odd">
<td align="left">SELECT way, railway, CASE WHEN railway in ('spur','siding') THEN 'yard' WHEN railway='disused' THEN 'disused' WHEN railway='rail' THEN 'main' ELSE 'other' END AS type FROM planet_osm_line WHERE railway IS NOT NULL ORDER BY z_order) as rail&quot;,</td>
</tr>
<tr class="even">
<td align="left">'Main' and 'yard' now become selectors that you can reference in your mss files.</td>
</tr>
<tr class="odd">
<td align="left">so you can reference yard, and as a selector and it will represent that selection you made in the SQL layer. (when railway row has values of spur or siding)</td>
</tr>
<tr class="even">
<td align="left"><code>#railway[type='yard'] { your rules for yard }</code></td>
</tr>
<tr class="odd">
<td align="left"><code>#railway[type='main'] { your rules for main }</code></td>
</tr>
<tr class="even">
<td align="left">see: https://github.com/hotosm/HDM-CartoCSS/blob/master/roads.mss</td>
</tr>
<tr class="odd">
<td align="left">a more advanced example: <code>SELECT way, tunnel, bridge, railway, service, CASE WHEN railway in ('spur','siding') or (railway='rail' and service in ('spur','siding','yard')) THEN 'yard' WHEN railway='disused' THEN 'disused' WHEN railway='rail' THEN 'main' ELSE 'other' END AS type FROM planet_osm_line WHERE railway IS NOT NULL AND railway!='abandoned' ORDER BY z_order) as rail&quot;,</code></td>
</tr>
<tr class="even">
<td align="left">==== ==Classes==:</td>
</tr>
<tr class="odd">
<td align="left">Opacity (and related comp-op) operates on a layer as a whole. However, it’s specified inline with the rest of the rules, which is confusing. This sort of thing shouldn’t work, or should perhaps throw a warning: <code>#foo[bar=1] { opacity: 0.2 } #foo[bar=2] { opacity: 0.8 }</code> My experience has been that opacity gets set just once, for the whole layer, and I’m not sure how to predict which one would win in this case.</td>
</tr>
<tr class="even">
<td align="left">https://github.com/mapbox/carto/issues/249</td>
</tr>
<tr class="odd">
<td align="left">==== Tilemill tooltips: (assume you already know what tooltips are...)</td>
</tr>
<tr class="even">
<td align="left">Yeah, you want awesome tooltips - (the content that is displayed when a user hover a marker with their cursor or when they click on a marker in your map) -</td>
</tr>
<tr class="odd">
<td align="left">However, if you want something that is a little complicated, like custom images for each of your points, it can stil be done although I would do this through leaflet instead of plotting them on a map in tilemill.</td>
</tr>
<tr class="even">
<td align="left">For example, I wanted to change the width of the tooltip so I could have a larger image display without the user having to scroll, as shown in the picture:</td>
</tr>
<tr class="odd">
<td align="left">What you'll need to do:</td>
</tr>
<tr class="even">
<td align="left">So, the default styling for the Tooltips is located at: https://github.com/mapbox/wax/blob/master/theme/controls.css</td>
</tr>
<tr class="odd">
<td align="left">Look for the relevant class and property within the CSS file, and place your edited code within the in this case, it's the class map-tooltip (shown below)</td>
</tr>
<tr class="even">
<td align="left"><code>&lt;style&gt; .map-tooltip { max-width:400px !important; } &lt;/style&gt;</code></td>
</tr>
<tr class="odd">
<td align="left">And insert the</td>
</tr>
<tr class="even">
<td align="left">As mentioned here- http://support.mapbox.com/discussions/tilemill/1460-customizing-the-tool-tips The changed width of the tooltip will not appear in Tilemill after. once you upload them to mapbox's server and view the your map online, you will see your changes. Some changes, like the opacity of the tooltip box, will display within Tilemill.</td>
</tr>
<tr class="odd">
<td align="left">Tooltips: https://github.com/mapbox/wax/blob/master/theme/controls.css - how to change the font ? font is not in there ?! - you cannot unless you have wax on your server, because of security concerns, see:</td>
</tr>
</tbody>
</table>
<p>One drawback that i'm immediately noticing too, to styling your markers in tilemill, is that if you're going to display them on a webpage (using mapbox.js), each time that you want to tweak them or debug it, you'll have to upload the entire project up to the web again,</p>
<p>====</p>
<p><em>My styling isn't displaying as I intended? Help?!</em></p>
<p>Most common culprit of this is that your data isn't included in the layer you're styling! Make sure your data is being included by checking the layer features (the little magnifying glass by the circle...)(NOTE: There may be some cases where this isn't correct - especially if you have many features in your layer) so follow the next step:</p>
<p>you're using SQL, put your query into an SQL editor like pgadmin.</p>
<p>==== <strong>Extra Resources, Great tools/Examples</strong>:</p>
<p><em>Where are some great examples of carto in action?!</em></p>
<p>(this listed ended up getting posted at: ) see: http://gis.stackexchange.com/questions/62348/is-there-a-carto-css-gallery-which-also-contains-code/62824#62824</p>
<p><em>Cartocc</em>:</p>
<p>Cartocc is a npm (module?) that is designed for people to collaborate together on tilemill projects. In most cases, your database names, the path to your JSON files will be different than your collaborators. Using this, you can customize your project settings</p>
<p>See for more details: https://github.com/yohanboniface/CartoCC</p>
<p>Also written by the author of cartocc, is the carto-sublime package in early development: https://github.com/yohanboniface/Carto-sublime</p>
<p>===== i need help?! checkout:</p>
<h1 id="mapbox-on-freenode-irc">mapbox on freenode (irc)</h1>
<p>support.mapbox.com and the gis.stackexchange</p>
<p>for crashing:</p>
<p>if you're using ubuntu, go to the directory where tilemill is installed in your terminal, , and then type in ./index.js - tilemill will startup. /usr/share/mapbox/</p>
<p>mac - i think yeah look for ~/Library/Logs/DiagnosticReports/node (if its a node error)</p>
<p>ENHANCEMENT TICKET TO Make: I've made a change, for example, the color of a landuse in the stylesheet, and it'll zoom into where I last saved, great. So, I see how the change affected in my immediate area, but if I want to see quickly, this other location ((within my area)) that also has this landuse, I have to zoom out, and then zoom back into the other area... I've had this come up a couple time in my workflows, it'd be a nice enhancement although I have not idea if this is feasible in any way, I'm guessing not.</p>
<p>OR a workaround could be, have your project open in server mode, two tabs on your internet browser, and have it open to the two affected areas.</p>
<p>Once you click on save, would the other one be refreshed as well ? verify.</p>
